<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TastyTales POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background:#fafafa; }
  header { text-align:center; padding:20px; background:#001b3b; color:#fff; }
  header img { width:180px; display:block; margin:0 auto 10px; }
  h1 { margin:0; font-size:24px; }
  main { padding:20px; max-width:520px; margin:auto; }

  .topButtons { display:flex; gap:10px; margin-bottom:15px; }
  .topButtons button {
    flex:1;
    padding:8px 10px;
    border-radius:6px;
    border:none;
    background:#eee;
    font-size:14px;
  }

  .card {
    background:#fff;
    border-radius:10px;
    box-shadow:0 1px 4px rgba(0,0,0,0.12);
    padding:15px 15px 10px;
    margin-bottom:16px;
  }

  .itemRow {
    display:grid;
    grid-template-columns: 1.6fr 0.9fr 1.1fr;
    align-items:center;
    gap:8px;
    margin-bottom:8px;
    font-size:15px;
  }

  .itemRow span.name { text-align:left; }
  .itemRow span.sub { text-align:right; }

  input[type="number"] {
    width:100%;
    font-size:16px;
    padding:4px 6px;
    box-sizing:border-box;
  }

  .totalBox .line {
    display:flex;
    justify-content:space-between;
    margin:4px 0;
    font-size:16px;
  }

  .totalLabel { font-weight:bold; }
  .totalValue { font-weight:bold; }

  button.mainBtn {
    width:100%;
    margin-top:12px;
    padding:13px;
    background:#ff7f3f;
    color:white;
    border:none;
    font-size:18px;
    border-radius:8px;
  }

  #qrScreen { display:none; text-align:center; padding:40px 20px; }
  #qrcode { margin:20px auto; }

  /* price settings panel */
  #pricePanel {
    display:none;
    margin-bottom:16px;
  }
  #pricePanel h3 { margin-top:0; font-size:16px; }
  #pricePanel .line {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin:6px 0;
  }
  #pricePanel label { flex:1; text-align:left; }
  #pricePanel input[type="number"] { width:110px; }
  #pricePanel .btnRow {
    display:flex;
    gap:8px;
    margin-top:8px;
  }
  #pricePanel .btnRow button {
    flex:1;
    padding:8px;
    border-radius:6px;
    border:none;
    font-size:14px;
  }
  #savePrices { background:#007bff; color:#fff; }
  #closePrices { background:#eee; }
</style>
</head>
<body>
<header>
  <!-- GitHub リポジトリに logo.png を置けば表示されます -->
  <img src="logo.png" alt="TastyTales Logo" />
  <h1>TastyTales POS</h1>
</header>

<main id="mainScreen">

  <div class="topButtons">
    <button id="openPrice">Price Settings</button>
  </div>

  <!-- 価格設定パネル -->
  <div id="pricePanel" class="card">
    <h3>Default Prices (yen)</h3>
    <div class="line">
      <label for="priceSoupInput">Soup</label>
      <input type="number" id="priceSoupInput" min="0">
    </div>
    <div class="line">
      <label for="pricePotatoInput">Potato</label>
      <input type="number" id="pricePotatoInput" min="0">
    </div>
    <div class="line">
      <label for="priceBeerInput">Beer</label>
      <input type="number" id="priceBeerInput" min="0">
    </div>
    <div class="btnRow">
      <button id="savePrices">Save</button>
      <button id="closePrices">Cancel</button>
    </div>
  </div>

  <!-- 商品入力 -->
  <div class="card">
    <div class="itemRow">
      <span class="name">Soup (¥<span id="priceSoupDisp">300</span>)</span>
      <input type="number" id="qtySoup" value="0" min="0">
      <span class="sub"><span id="subSoup">0</span> yen</span>
    </div>
    <div class="itemRow">
      <span class="name">Potato (¥<span id="pricePotatoDisp">400</span>)</span>
      <input type="number" id="qtyPotato" value="0" min="0">
      <span class="sub"><span id="subPotato">0</span> yen</span>
    </div>
    <div class="itemRow">
      <span class="name">Beer (¥<span id="priceBeerDisp">500</span>)</span>
      <input type="number" id="qtyBeer" value="0" min="0">
      <span class="sub"><span id="subBeer">0</span> yen</span>
    </div>
  </div>

  <!-- 合計・預かり・お釣り -->
  <div class="card totalBox">
    <div class="line">
      <span class="totalLabel">Total</span>
      <span class="totalValue"><span id="total">0</span> yen</span>
    </div>
    <div class="line">
      <span>Deposit</span>
      <input type="number" id="deposit" value="0" min="0">
    </div>
    <div class="line">
      <span>Change</span>
      <span><span id="change">0</span> yen</span>
    </div>
  </div>

  <button class="mainBtn" id="payBtn">Complete Payment</button>
</main>

<div id="qrScreen">
  <h2>Receipt</h2>
  <div id="qrcode"></div>
  <button class="mainBtn" onclick="location.reload()">Done</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// ====== 設定（最初のデフォルト価格） ======
let PRICE = { soup:300, potato:400, beer:500 };

// ★ あなたの Apps Script Web アプリ URL をここに貼る
const API_URL = "PASTE_YOUR_SCRIPT_URL_HERE";

const qtySoup    = document.getElementById("qtySoup");
const qtyPotato  = document.getElementById("qtyPotato");
const qtyBeer    = document.getElementById("qtyBeer");
const depositEl  = document.getElementById("deposit");
const totalEl    = document.getElementById("total");
const changeEl   = document.getElementById("change");

const subSoupEl   = document.getElementById("subSoup");
const subPotatoEl = document.getElementById("subPotato");
const subBeerEl   = document.getElementById("subBeer");

const priceSoupDisp   = document.getElementById("priceSoupDisp");
const pricePotatoDisp = document.getElementById("pricePotatoDisp");
const priceBeerDisp   = document.getElementById("priceBeerDisp");

// ========== 価格設定の読み込み・保存 ==========

// LocalStorage から読み込み
function loadPricesFromStorage() {
  const s = localStorage.getItem("priceSoup");
  const p = localStorage.getItem("pricePotato");
  const b = localStorage.getItem("priceBeer");
  if (s !== null) PRICE.soup = +s;
  if (p !== null) PRICE.potato = +p;
  if (b !== null) PRICE.beer = +b;

  // 表示更新
  priceSoupDisp.textContent   = PRICE.soup;
  pricePotatoDisp.textContent = PRICE.potato;
  priceBeerDisp.textContent   = PRICE.beer;

  // 設定パネル側の入力値にも反映
  document.getElementById("priceSoupInput").value   = PRICE.soup;
  document.getElementById("pricePotatoInput").value = PRICE.potato;
  document.getElementById("priceBeerInput").value   = PRICE.beer;
}

// 保存
function savePrices() {
  const s = +document.getElementById("priceSoupInput").value || 0;
  const p = +document.getElementById("pricePotatoInput").value || 0;
  const b = +document.getElementById("priceBeerInput").value || 0;

  PRICE = { soup:s, potato:p, beer:b };

  localStorage.setItem("priceSoup", s);
  localStorage.setItem("pricePotato", p);
  localStorage.setItem("priceBeer", b);

  priceSoupDisp.textContent   = s;
  pricePotatoDisp.textContent = p;
  priceBeerDisp.textContent   = b;

  updateTotal();
}

// パネル開閉
const pricePanel  = document.getElementById("pricePanel");
document.getElementById("openPrice").onclick  = () => { pricePanel.style.display = "block"; };
document.getElementById("closePrices").onclick = () => { pricePanel.style.display = "none"; };
document.getElementById("savePrices").onclick  = () => { savePrices(); pricePanel.style.display = "none"; };

// ========== 合計のリアルタイム更新 ==========

function updateTotal() {
  const sQty = +qtySoup.value   || 0;
  const pQty = +qtyPotato.value || 0;
  const bQty = +qtyBeer.value   || 0;

  const subS = sQty * PRICE.soup;
  const subP = pQty * PRICE.potato;
  const subB = bQty * PRICE.beer;

  subSoupEl.textContent   = subS;
  subPotatoEl.textContent = subP;
  subBeerEl.textContent   = subB;

  const total = subS + subP + subB;
  totalEl.textContent = total;

  const dep = +depositEl.value || 0;
  changeEl.textContent = dep - total;
}

// 入力が変わったら毎回計算
[qtySoup, qtyPotato, qtyBeer, depositEl].forEach(el => {
  el.addEventListener("input", updateTotal);
});

// 初期化
loadPricesFromStorage();
updateTotal();

// ========== 決済処理 ==========

const mainScreen = document.getElementById("mainScreen");
const qrScreen   = document.getElementById("qrScreen");
const qrArea     = document.getElementById("qrcode");

document.getElementById("payBtn").onclick = () => {
  updateTotal(); // 念のため最新に

  const payload = {
    soup:   +qtySoup.value   || 0,
    potato: +qtyPotato.value || 0,
    beer:   +qtyBeer.value   || 0,
    total:  +totalEl.textContent || 0
  };

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.text())
  .then(pdfUrl => {
    mainScreen.style.display = "none";
    qrScreen.style.display   = "block";
    qrArea.innerHTML = "";
    new QRCode(qrArea, pdfUrl);
  })
  .catch(err => {
    alert("Error: " + err);
  });
};
</script>
</body>
</html>

